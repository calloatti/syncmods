using HarmonyLib;
using UnityEngine;
using UnityEngine.UIElements;
using Timberborn.MainMenuPanels;
using Timberborn.Localization; // Added for ILoc
using System;
using System.Reflection;

namespace Calloatti.SyncMods
{
    [HarmonyPatch(typeof(MainMenuPanel), "GetPanel")]
    public static class MainMenuPanelPatch
    {
        private static void Postfix(MainMenuPanel __instance, VisualElement __result)
        {
            if (__result == null || __result.Q("SyncModsButton") != null) return;

            // 1. Find the blueprint button
            VisualElement loadButton = __result.Q("LoadGameButton");
            if (loadButton == null) return;

            // 2. Create the clone
            Type buttonType = loadButton.GetType();
            Button syncButton = (Button)Activator.CreateInstance(buttonType);

            syncButton.name = "SyncModsButton";

            // --- LOCALIZATION LOGIC ---
            // We grab the localization service from the MainMenuPanel instance
            FieldInfo locField = typeof(MainMenuPanel).GetField("_loc", BindingFlags.NonPublic | BindingFlags.Instance);
            ILoc loc = (ILoc)locField?.GetValue(__instance);

            // Set text from your CSV key, or fallback to "Load Mods" if service is missing
            syncButton.text = loc != null ? loc.T("calloatti.SyncMods.Menu.SyncMods") : "Sync Mods";

            // 3. COPY STYLESHEETS
            int sheetCount = loadButton.styleSheets.count;
            for (int i = 0; i < sheetCount; i++)
            {
                syncButton.styleSheets.Add(loadButton.styleSheets[i]);
            }

            // 4. COPY CLASSES
            foreach (var className in loadButton.GetClasses())
            {
                syncButton.AddToClassList(className);
            }

            // 5. MATCH LAYOUT
            syncButton.style.width = loadButton.style.width;
            syncButton.style.height = loadButton.style.height;
            syncButton.style.marginBottom = loadButton.style.marginBottom;
            syncButton.style.marginTop = loadButton.style.marginTop;

            // 6. CLICK EVENT
            syncButton.RegisterCallback<ClickEvent>(evt => {
                SyncModsPanel.OnSyncButtonClicked(__instance);
            });

            // 7. INJECT AT THE TOP
            VisualElement container = loadButton.parent;
            if (container != null)
            {
                container.Insert(0, syncButton);
            }
        }
    }
}